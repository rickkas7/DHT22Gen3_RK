<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DHT22Gen3_RK: DHT22Gen3 Library</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">DHT22Gen3_RK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title"><a class="el" href="class_d_h_t22_gen3.html" title="Class for interfacing with one or more DHT22 sensors on a Gen3 Particle device. ">DHT22Gen3</a> Library </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>There's been a problem with DHT22 libraries on Gen 3 devices (Argon, Boron, Xenon). Interrupt latency causes it to misinterpret bits for interrupt-based libraries (like PietteTech_DHT) and bit-banging isn't much better. The narrowest pulse is 26-28 us.</p>
<p>I created a new library, DHT22Gen3_RK, that takes an entirely different approach. It uses the nRF52 I2S peripheral not to capture sound data, but as a DMA-based digital signal sampler. It can grab a full DHT22 sample into a 360 byte buffer at a 512 kHz sampling rate. It doesn't require any interrupts, no timers are required, and it's completely non-blocking. It doesn't have to disable interrupts or thread swapping.</p>
<p>I ran a test overnight and captured 14,703 samples every 2.5 seconds with no checksum errors. The library will retry on error, but didn't have to at all.</p>
<p>It can sample multiple sensors (sequentially, not at the same time), one per GPIO pin. There one annoying caveat: You need to allocate two spare GPIO pins. The I2S peripheral requires that you expose SCK and LRCK on physical GPIO pins or it doesn't work. These signals are of no use for capturing DHT22 samples, but they still need to be allocated. Most people have a few GPIO left, so hopefully that's OK.</p>
<p>The API is callback/lambda based, as it takes about 24 milliseconds to query a DHT22. The callback allows the loop to flow freely during this time, but the callback is dispatched from the loop context so you can still do things like Particle.publish from the callback. The callback is particularly helpful if a retry is required because of a bad checksum. Since the DHT22 can only be queried every 2 seconds, retries take a long time.</p>
<ul>
<li>Repository: <a href="https://github.com/rickkas7/DHT22Gen3_RK">https://github.com/rickkas7/DHT22Gen3_RK</a></li>
<li>License: MIT</li>
<li><a href="https://rickkas7.github.io/DHT22Gen3_RK/">Full browsable API documentation</a></li>
</ul>
<h2>Example Usage</h2>
<div class="fragment"><div class="line">#include &quot;DHT22Gen3_RK.h&quot;</div><div class="line"></div><div class="line">SerialLogHandler logHandler;</div><div class="line"></div><div class="line">SYSTEM_THREAD(ENABLED);</div><div class="line"></div><div class="line">// How often to check the temperature in humidity in milliseconds</div><div class="line">const unsigned long CHECK_INTERVAL = 5000;</div><div class="line">unsigned long lastCheck = 0;</div><div class="line"></div><div class="line">// The two parameters are any available GPIO pins. They will be used as output but the signals aren&#39;t</div><div class="line">// particularly important for DHT11 and DHT22 sensors. They do need to be valid pins, however.</div><div class="line">DHT22Gen3 dht(A4, A5);</div><div class="line"></div><div class="line">void sampleCallback(DHTSample sample);</div><div class="line"></div><div class="line">void setup() {</div><div class="line">    dht.setup();</div><div class="line">}</div><div class="line"></div><div class="line">void loop() {</div><div class="line">    dht.loop();</div><div class="line"></div><div class="line">    if (millis() - lastCheck &gt;= CHECK_INTERVAL) {</div><div class="line">        lastCheck = millis();</div><div class="line"></div><div class="line">        dht.getSample(A3, sampleCallback);</div><div class="line">    }</div><div class="line"></div><div class="line">}</div><div class="line"></div><div class="line">void sampleCallback(DHTSample sample) {</div><div class="line">    // The callback is called at loop() (from dht.loop()) so it&#39;s safe to do anything you would normally</div><div class="line">    // do at loop time (like publish) without having to worry about thread concurrency.</div><div class="line"></div><div class="line">    if (sample.isSuccess()) {</div><div class="line">        Log.info(&quot;sampleResult=%d tempF=%.1f tempC=%.1f humidity=%.1f tries=%d&quot;,</div><div class="line">                (int) sample.getSampleResult(), sample.getTempF(), sample.getTempC(), sample.getHumidity(), sample.getTries() );</div><div class="line">        Log.info(&quot;dewPointF=%.1f dewPointC=%.1f&quot;,</div><div class="line">                sample.getDewPointF(), sample.getDewPointC() );</div><div class="line">    }</div><div class="line">    else {</div><div class="line">        Log.info(&quot;sample is not valid sampleResult=%d&quot;, (int) sample.getSampleResult());</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p>The <code>getSample()</code> method can also take a C++11 lambda, which is handy for calling member functions or implementing the method inline:</p>
<div class="fragment"><div class="line">dht.getSample(A3, [](DHTSample sample) {</div><div class="line">    if (sample.isSuccess()) {</div><div class="line">        char buf[128];</div><div class="line">        snprintf(buf, sizeof(buf), &quot;{\&quot;temp\&quot;:%.1f,\&quot;hum\&quot;:%1.f}&quot;, sample.getTempC(), sample.getHumidity());</div><div class="line">        if (Particle.connected()) {</div><div class="line">            Particle.publish(&quot;temperatureTest&quot;, buf, PRIVATE);</div><div class="line">            Log.info(&quot;published: %s&quot;, buf);</div><div class="line">        }</div><div class="line">        else {</div><div class="line">            Log.info(&quot;not published: %s&quot;, buf);</div><div class="line">        }</div><div class="line">    }</div><div class="line">    else {</div><div class="line">        Log.info(&quot;sample is not valid sampleResult=%d&quot;, (int) sample.getSampleResult());</div><div class="line">    }</div><div class="line">});</div></div><!-- fragment --><h2>More details</h2>
<p>Include the <code>DHT22Gen3_RK</code> library and include its header file:</p>
<div class="fragment"><div class="line">#include &quot;DHT22Gen3_RK.h&quot;</div></div><!-- fragment --><p>Add a global variable. There should only be one instance of this object, and it should be in a global scope.</p>
<div class="fragment"><div class="line">DHT22Gen3 dht(A4, A5);</div></div><!-- fragment --><p>The two parameters are unused GPIO pins. These can be A pins, D pins, even unused special port pins that you are not otherwise using (TX, RX, SCK, MISO, MOSI). They do need to be valid pins, however, and not the same pin. The output will be 512 kHz signal on the first pin and a 32 kHz signal on the second. You shouldn't connect anything to these pins. They're necessary because the I2S peripheral that's used to decode the DHT22 signal requires the pins.</p>
<p>From <code>setup()</code> call <code>dht.setup()</code>:</p>
<div class="fragment"><div class="line">void setup() {</div><div class="line">    dht.setup();</div><div class="line">}</div></div><!-- fragment --><p>From <code>loop()</code> call <code>dht.loop()</code>:</p>
<div class="fragment"><div class="line">void loop() {</div><div class="line">    dht.loop();</div><div class="line"></div><div class="line">    // Rest of your code</div><div class="line">}</div></div><!-- fragment --><p>You should call dht.loop() on every loop call even if you are not currently sampling data. It uses very little processor time when not active.</p>
<p>Use the <code>dht.getSample()</code> method above to query the sensor. It will take 24 milliseconds normally, but could take up to 9 seconds to get a result.</p>
<h2>Version History</h2>
<h4>0.0.1 (2019-12-13)</h4>
<ul>
<li>Initial version! There may be bugs still. </li>
</ul>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.14
</small></address>
</body>
</html>
